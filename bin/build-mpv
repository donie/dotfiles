#!/usr/bin/env bash

# mpv Auto-Build Script for macOS
# Run manually to update, build, and install mpv

set -e  # Exit on any error

# ============================================================================
# Configuration
# ============================================================================
MPV_REPO_DIR="$HOME/_runtime/mpv"  # UPDATE THIS to your mpv repo location
MPV_REPO_URL="https://github.com/mpv-player/mpv.git"
ICON_FILE="$HOME/dotfiles/mpv/MPV.icns"  # UPDATE THIS to your icon file location
INSTALL_DIR="/Applications"
BUILD_STATIC=false  # Set to true if you want static build with dylibbundler

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# Helper Functions
# ============================================================================
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ============================================================================
# Pre-flight Checks
# ============================================================================
log_info "Starting mpv build process..."

# Check if git is installed
if ! command -v git &> /dev/null; then
    log_error "git is not installed. Please install it first:"
    log_error "  xcode-select --install"
    exit 1
fi

# Check if icon file exists (only warn, not critical)
if [ ! -f "$ICON_FILE" ]; then
    log_warning "Icon file not found at: $ICON_FILE"
    log_warning "Will skip icon setting step"
    SKIP_ICON=true
else
    SKIP_ICON=false
fi

# Check if fileicon is installed
if [ "$SKIP_ICON" = false ] && ! command -v fileicon &> /dev/null; then
    log_warning "fileicon not found. Install with: brew install fileicon"
    log_warning "Will skip icon setting step"
    SKIP_ICON=true
fi

# ============================================================================
# Clone or Verify Repository
# ============================================================================
if [ ! -d "$MPV_REPO_DIR" ]; then
    log_info "mpv repository not found at: $MPV_REPO_DIR"
    log_info "Cloning mpv repository from $MPV_REPO_URL..."

    # Create parent directory if it doesn't exist
    PARENT_DIR=$(dirname "$MPV_REPO_DIR")
    mkdir -p "$PARENT_DIR"

    git clone "$MPV_REPO_URL" "$MPV_REPO_DIR"
    log_success "Repository cloned successfully"
elif [ ! -d "$MPV_REPO_DIR/.git" ]; then
    log_error "Directory exists at $MPV_REPO_DIR but is not a git repository"
    log_error "Please remove it or choose a different location"
    exit 1
else
    log_info "Repository found at: $MPV_REPO_DIR"
fi

# ============================================================================
# Install Build Dependencies
# ============================================================================
log_info "Checking build dependencies..."

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    log_error "Homebrew is not installed. Please install it first:"
    log_error "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

# Check for meson (build system)
if ! command -v meson &> /dev/null; then
    log_warning "meson not found, installing build dependencies..."
    log_info "This will run: brew install --build-from-source --only-dependencies mpv"
    log_info "This may take a while on first run..."

    brew install --build-from-source --only-dependencies mpv

    log_success "Build dependencies installed"
else
    log_info "meson found: $(meson --version)"
fi

# Check for ninja (build tool used by meson, NOT in mpv deps)
if ! command -v ninja &> /dev/null; then
    log_warning "ninja not found, installing..."
    brew install ninja
else
    log_info "ninja found: $(ninja --version)"
fi

# Check luajit-openresty (specific variant needed, NOT the regular luajit)
if ! brew list luajit-openresty &>/dev/null; then
    log_warning "luajit-openresty not found, installing..."
    brew install luajit-openresty
else
    log_info "luajit-openresty is installed"
fi

# Verify meson is now available
if ! command -v meson &> /dev/null; then
    log_error "meson still not found after installation attempt"
    log_error "Please run manually: brew install --build-from-source --only-dependencies mpv"
    exit 1
fi

log_success "All build dependencies verified"

# ============================================================================
# Update Repository
# ============================================================================
log_info "Navigating to mpv repository: $MPV_REPO_DIR"
cd "$MPV_REPO_DIR"

log_info "Checking for updates..."
git fetch origin master

LOCAL_COMMIT=$(git rev-parse HEAD)
REMOTE_COMMIT=$(git rev-parse origin/master)

if [ "$LOCAL_COMMIT" = "$REMOTE_COMMIT" ]; then
    log_info "Already up to date (commit: ${LOCAL_COMMIT:0:8})"
    read -p "No updates found. Continue building anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Exiting..."
        exit 0
    fi
else
    log_info "Updates found!"
    log_info "Current: ${LOCAL_COMMIT:0:8}"
    log_info "Remote:  ${REMOTE_COMMIT:0:8}"
fi

log_info "Resetting repository..."
git reset --hard
git clean --force -d -x
git pull origin master

log_success "Repository updated successfully"

# ============================================================================
# Build mpv
# ============================================================================
log_info "Setting up build with meson..."
meson setup build --wipe 2>/dev/null || meson setup build

log_info "Compiling mpv (this may take a few minutes)..."
meson compile -C build

log_info "Testing built binary..."
./build/mpv --version

log_success "Binary compiled successfully"

# ============================================================================
# Create App Bundle
# ============================================================================
log_info "Creating macOS app bundle..."
./TOOLS/osxbundle.py --skip-deps build/mpv

if [ "$BUILD_STATIC" = true ]; then
    log_info "Building static bundle with dylibbundler..."
    if ! command -v dylibbundler &> /dev/null; then
        log_error "dylibbundler not found. Install with: brew install dylibbundler"
        exit 1
    fi
    dylibbundler --bundle-deps \
        --dest-dir build/mpv.app/Contents/MacOS/lib/ \
        --install-path @executable_path/lib/ \
        --fix-file build/mpv.app/Contents/MacOS/mpv

    log_info "Testing app bundle binary..."
    ./build/mpv.app/Contents/MacOS/mpv --version
fi

log_success "App bundle created successfully"

# ============================================================================
# Install to Applications
# ============================================================================
log_info "Installing to $INSTALL_DIR..."

if [ -d "$INSTALL_DIR/mpv.app" ]; then
    log_warning "Existing mpv.app found, removing..."
    rm -rf "$INSTALL_DIR/mpv.app"
fi

cp -R build/mpv.app "$INSTALL_DIR/"
log_success "mpv.app installed to $INSTALL_DIR"

# ============================================================================
# Set Custom Icon
# ============================================================================
if [ "$SKIP_ICON" = false ]; then
    log_info "Setting custom icon..."

    # Check if we need sudo
    if [ -w "$INSTALL_DIR/mpv.app" ]; then
        fileicon set "$INSTALL_DIR/mpv.app" "$ICON_FILE"
    else
        log_info "Requesting sudo permissions for icon setting..."
        sudo fileicon set "$INSTALL_DIR/mpv.app" "$ICON_FILE"
    fi

    # Refresh Finder to show new icon
    killall Finder 2>/dev/null || true

    log_success "Custom icon applied"
fi

# ============================================================================
# Final Summary
# ============================================================================
echo ""
log_success "============================================"
log_success "mpv build and installation complete!"
log_success "============================================"
log_info "Version: $(./build/mpv --version | head -n 1)"
log_info "Location: $INSTALL_DIR/mpv.app"
log_info "Build directory: $MPV_REPO_DIR/build"
echo ""
log_info "You can now launch mpv from Applications or run:"
log_info "  open -a mpv"
echo ""
